<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Interseção à Vante - Topografia</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
}
#painel {
  padding: 10px;
  background: #f2f2f2;
}
input {
  width: 100%;
  margin-bottom: 6px;
  padding: 6px;
}
button {
  width: 100%;
  padding: 10px;
  font-size: 16px;
}
#map {
  height: 60vh;
}
.resultado {
  font-size: 13px;
  background: #fff;
  padding: 8px;
  margin-top: 6px;
}
</style>
</head>

<body>

<div id="painel">
  <h3>Interseção à Vante</h3>

  <b>Ponto A (UTM 25S)</b>
  <input id="xA" placeholder="Easting A">
  <input id="yA" placeholder="Northing A">

  <b>Ponto B (UTM 25S)</b>
  <input id="xB" placeholder="Easting B">
  <input id="yB" placeholder="Northing B">

  <b>Direções Horizontais</b>
  <input id="dhAP" placeholder="DH A→P (graus)">
  <input id="dhBP" placeholder="DH B→P (graus)">

  <button onclick="calcular()">Calcular</button>

  <div id="saida" class="resultado"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ================= FUNÇÕES =================

const normalizar360 = a => ((a % 360) + 360) % 360;

const normalizar180 = a => {
  a = normalizar360(a);
  return a > 180 ? 360 - a : a;
};

// UTM 25S → WGS84
const utm25SParaLatLon = (E, N) => {
  const a = 6378137;
  const f = 1 / 298.257223563;
  const k0 = 0.9996;
  const e = Math.sqrt(f * (2 - f));
  const e1sq = e * e / (1 - e * e);
  const lon0 = -33 * Math.PI / 180;

  let x = E - 500000;
  let y = N - 10000000;

  const M = y / k0;
  const mu = M / (a * (1 - e*e/4 - 3*e**4/64 - 5*e**6/256));

  const phi1 =
    mu +
    (3*e1sq/2 - 27*e1sq**3/32)*Math.sin(2*mu) +
    (21*e1sq**2/16 - 55*e1sq**4/32)*Math.sin(4*mu) +
    (151*e1sq**3/96)*Math.sin(6*mu);

  const N1 = a / Math.sqrt(1 - e*e*Math.sin(phi1)**2);
  const T1 = Math.tan(phi1)**2;
  const C1 = e1sq * Math.cos(phi1)**2;
  const R1 = a*(1-e*e) / Math.pow(1-e*e*Math.sin(phi1)**2,1.5);
  const D = x/(N1*k0);

  const lat =
    phi1 -
    (N1*Math.tan(phi1)/R1) *
    (D**2/2 -
     (5+3*T1+10*C1-4*C1**2-9*e1sq)*D**4/24);

  const lon =
    lon0 +
    (D -
     (1+2*T1+C1)*D**3/6)/Math.cos(phi1);

  return {
    lat: lat * 180 / Math.PI,
    lon: lon * 180 / Math.PI
  };
};

// ================= MAPA =================

const map = L.map('map').setView([-8, -35], 15);
L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  { maxZoom: 20 }
).addTo(map);

let camada;

// ================= CÁLCULO =================

function calcular() {
  if (camada) camada.remove();

  const xA = +xAInput.value;
  const yA = +yAInput.value;
  const xB = +xBInput.value;
  const yB = +yBInput.value;
  const dhAP = +dhAPInput.value;
  const dhBP = +dhBPInput.value;

  const dX = xB - xA;
  const dY = yB - yA;

  const azAB = normalizar360(Math.atan2(dX, dY) * 180 / Math.PI);
  const dAB = Math.hypot(dX, dY);

  const azAP = normalizar360(azAB + dhAP);
  const azBA = normalizar360(azAB + 180);
  const azBP = normalizar360(azBA + dhBP);

  const angA = normalizar180(azAB - azAP);
  const angB = normalizar180(azBP - azBA);
  const angP = 180 - angA - angB;

  const dAP = dAB * Math.sin(angB * Math.PI/180) / Math.sin(angP * Math.PI/180);

  const xP = xA + dAP * Math.sin(azAP * Math.PI/180);
  const yP = yA + dAP * Math.cos(azAP * Math.PI/180);

  const A = utm25SParaLatLon(xA, yA);
  const B = utm25SParaLatLon(xB, yB);
  const P = utm25SParaLatLon(xP, yP);

  camada = L.layerGroup([
    L.marker([A.lat, A.lon]).bindPopup("A"),
    L.marker([B.lat, B.lon]).bindPopup("B"),
    L.marker([P.lat, P.lon]).bindPopup("P"),
    L.polygon([[A.lat,A.lon],[B.lat,B.lon],[P.lat,P.lon]])
  ]).addTo(map);

  map.fitBounds(camada.getBounds());

  saida.innerHTML = `
  <b>Azimutes</b><br>
  AB: ${azAB.toFixed(6)}°<br>
  AP: ${azAP.toFixed(6)}°<br>
  BP: ${azBP.toFixed(6)}°<br><br>

  <b>Ângulos Internos</b><br>
  A: ${angA.toFixed(6)}°<br>
  B: ${angB.toFixed(6)}°<br>
  P: ${angP.toFixed(6)}°<br>
  `;
}

// inputs
const xAInput = document.getElementById('xA');
const yAInput = document.getElementById('yA');
const xBInput = document.getElementById('xB');
const yBInput = document.getElementById('yB');
const dhAPInput = document.getElementById('dhAP');
const dhBPInput = document.getElementById('dhBP');
const saida = document.getElementById('saida');
</script>

</body>
</html>
